let s,r,i=[];async function m(){const{Map:n}=await google.maps.importLibrary("maps");s=new n(document.getElementById("map"),{center:{lat:35.6812,lng:139.7671},zoom:8}),await g()}async function g(){i=await(await fetch(reportsApiUrl)).json();const e=document.getElementById("report-list");i.forEach(a=>{const t=document.createElement("li");t.className="border-b pb-2 cursor-pointer hover:bg-gray-100",t.dataset.lat=a.latitude??0,t.dataset.lng=a.longitude??0,t.dataset.name=a.user.name,t.dataset.id=a.id,t.innerHTML=`<p class="text-sm text-gray-600">${new Date(a.created_at).toLocaleString()}</p>`,e.appendChild(t)})}async function c(n,e,a,t){const{Marker:o}=await google.maps.importLibrary("marker"),l={lat:parseFloat(n),lng:parseFloat(e)};s.setCenter(l),s.setZoom(15),r&&r.setMap(null),r=new o({map:s,position:l,title:a}),u(t)}function u(n){const e=i.find(o=>o.id==n),a=document.getElementById("report-detail-content"),t=document.getElementById("report-detail");if(e){const o=`${storageUrl}/${e.photo_path}`;a.innerHTML=`
            <p><strong>日時:</strong> ${new Date(e.created_at).toLocaleString()}</p>
            <p><strong>画像:</strong> <img src="${o}" alt="報告画像" class="w-full h-auto" /></p>
            <p><strong>結果:</strong> ${e.identification_result}</p>
        `,t.classList.remove("hidden")}else console.error(`Report with ID ${n} not found`)}function L(){const n=document.getElementById("report-list").children;Array.from(n).forEach(e=>{const a={lat:parseFloat(e.dataset.lat),lng:parseFloat(e.dataset.lng)};new google.maps.Marker({position:a,map:s,title:e.dataset.name}).addListener("click",()=>{c(e.dataset.lat,e.dataset.lng,e.dataset.name,e.dataset.id)})})}function f(){document.getElementById("report-list").addEventListener("click",a=>{const t=a.target.closest("li");if(t){const o=t.dataset.lat,l=t.dataset.lng,d=t.dataset.name,p=t.dataset.id;c(o,l,d,p)}}),document.getElementById("plot-all-reports").addEventListener("click",L)}document.addEventListener("DOMContentLoaded",()=>{m(),f()});
