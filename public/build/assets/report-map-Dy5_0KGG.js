let s,r,i=[];async function m(){const{Map:a}=await google.maps.importLibrary("maps");s=new a(document.getElementById("map"),{center:{lat:35.6812,lng:139.7671},zoom:8}),await g()}async function g(){i=await(await fetch(reportsApiUrl)).json();const t=document.getElementById("report-list");i.forEach(n=>{const e=document.createElement("li");e.className="border-b pb-2 cursor-pointer hover:bg-gray-100",e.dataset.lat=n.latitude??0,e.dataset.lng=n.longitude??0,e.dataset.name=n.user.name,e.dataset.id=n.id,e.innerHTML=`<p class="font-semibold">${n.user.name}</p>
                              <p class="text-sm text-gray-600">${new Date(n.created_at).toLocaleString()}</p>`,t.appendChild(e)})}async function c(a,t,n,e){const{Marker:o}=await google.maps.importLibrary("marker"),l={lat:parseFloat(a),lng:parseFloat(t)};s.setCenter(l),s.setZoom(15),r&&r.setMap(null),r=new o({map:s,position:l,title:n}),u(e)}function u(a){const t=i.find(o=>o.id===a),n=document.getElementById("report-detail-content"),e=document.getElementById("report-detail");t?(n.innerHTML=`
            <p><strong>報告者:</strong> ${t.user.name}</p>
            <p><strong>日時:</strong> ${new Date(t.created_at).toLocaleString()}</p>
            <p><strong>画像:</strong> <img src="${t.image_url}" alt="報告画像" class="w-full h-auto" /></p>
            <p><strong>結果:</strong> ${t.identification_result}</p>
        `,e.classList.remove("hidden")):console.error(`Report with ID ${a} not found`)}function f(){const a=document.getElementById("report-list").children;Array.from(a).forEach(t=>{const n={lat:parseFloat(t.dataset.lat),lng:parseFloat(t.dataset.lng)};new google.maps.Marker({position:n,map:s,title:t.dataset.name}).addListener("click",()=>{c(t.dataset.lat,t.dataset.lng,t.dataset.name,t.dataset.id)})})}function L(){document.getElementById("report-list").addEventListener("click",n=>{const e=n.target.closest("li");if(e){const o=e.dataset.lat,l=e.dataset.lng,d=e.dataset.name,p=e.dataset.id;c(o,l,d,p)}}),document.getElementById("plot-all-reports").addEventListener("click",f)}document.addEventListener("DOMContentLoaded",()=>{m(),L()});
