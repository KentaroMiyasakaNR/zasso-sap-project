if(typeof window.reportScriptLoaded>"u"){let n=function(e){console.log(`[DEBUG] ${e}`)},d=function(e){if(n("previewImage called"),e.files&&e.files[0]){const t=new FileReader;t.onload=function(o){n("FileReader onload called"),u.src=o.target.result,v.style.display="block"},t.readAsDataURL(e.files[0])}},g=function(e){if(e.preventDefault(),console.log("同定分析analyzeImage called"),!c.files||c.files.length===0){i.innerHTML="<p>写真を選択してください。</p>";return}const t=new FormData(l);fetch(l.action,{method:"POST",body:t,headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content}}).then(o=>o.json()).then(o=>{o&&o.choices&&o.choices[0]&&o.choices[0].message?(i.innerHTML=`<p>${o.choices[0].message.content}</p>`,p.style.display="inline-block"):(console.error("Unexpected data structure:",o),i.innerHTML="<p>予期しないデータ構造です。管理者に連絡してください。</p>")}).catch(o=>{console.error("Error:",o),i.innerHTML="<p>エラーが発生しました。もう一度お試しください。</p>"})},y=function(){I.src=u.src,f.style.display="block"},s=function(){f.style.display="none"},h=function(){const e=new FormData;e.append("photo",c.files[0]),e.append("identification_result",i.innerText),"geolocation"in navigator?navigator.geolocation.getCurrentPosition(function(t){e.append("latitude",t.coords.latitude),e.append("longitude",t.coords.longitude),r(e)},function(t){console.error("位置情報の取得に失敗しました:",t),r(e)}):r(e)},r=function(e){fetch("/reports",{method:"POST",body:e,headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content}}).then(t=>t.json()).then(t=>{console.log("報告が送信されました:",t),alert("報告が正常に送信されました。"),s()}).catch(t=>{console.error("報告の送信中にエラーが発生しました:",t),alert("報告の送信中にエラーが発生しました。もう一度お試しください。")})},B=function(){n("Initializing event listeners"),m.addEventListener("click",function(){n("selectPhotoBtn clicked"),c.click()}),c.addEventListener("change",function(){n("File selected: "+(this.files[0]?this.files[0].name:"No file")),d(this)}),l.addEventListener("submit",g),p.addEventListener("click",y),F.addEventListener("click",s),L.addEventListener("click",h),n("Event listeners initialized")},E=function(){n("Checking elements"),n("selectPhotoBtn: "+(m?"Found":"Not found")),n("photoInput: "+(c?"Found":"Not found")),n("uploadForm: "+(l?"Found":"Not found")),n("analyzeBtn: "+(w?"Found":"Not found"))},a=function(){n("DOMContentLoaded event fired"),E(),B()};var k=n,P=d,S=g,D=y,R=s,T=h,M=r,z=B,N=E,b=a;window.reportScriptLoaded=!0;const u=document.getElementById("preview"),v=document.getElementById("imagePreview"),l=document.getElementById("uploadForm"),i=document.getElementById("result"),c=document.getElementById("photo"),m=document.getElementById("selectPhotoBtn"),w=document.getElementById("analyzeBtn"),p=document.getElementById("reportBtn"),f=document.getElementById("reportModal"),I=document.getElementById("modalPreview"),L=document.getElementById("confirmReportBtn"),F=document.getElementById("cancelReportBtn");document.readyState==="loading"?document.addEventListener("DOMContentLoaded",a):a(),window.previewImage=d,n("Script loaded")}else console.warn("Report script already loaded. Skipping re-initialization.");
